/**
 * USER MODEL (MongoDB Schema)
 * ============================
 * Defines the structure of user documents in MongoDB
 * 
 * This schema handles ALL 4 user roles:
 * - ADMIN: System administrator
 * - HOD: Head of Department
 * - TEACHER: Faculty member
 * - STUDENT: Student account
 */

const mongoose = require('mongoose');

// ============================================================
// USER SCHEMA DEFINITION
// ============================================================

const userSchema = new mongoose.Schema({
  
  // ------------------------------------------------------------
  // COMMON FIELDS (All Users)
  // ------------------------------------------------------------
  
  /**
   * email (String, Required, Unique)
   * - Primary login identifier
   * - Must be unique across all users
   * - Used for authentication
   * Examples: admin@gmail.com, mypt1991@gmail.com
   */
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,      // Convert to lowercase for consistency
    trim: true            // Remove whitespace
  },

  /**
   * password (String, Required)
   * - Stored as bcrypt hash (NEVER plain text)
   * - Hash generated using bcrypt with 10 salt rounds
   * - Original password is never stored
   * Example: $2b$10$abcd1234... (60 characters)
   */
  password: {
    type: String,
    required: true
  },

  /**
   * role (String, Required)
   * - Determines user permissions and dashboard access
   * - Enum: Only these 4 values allowed
   * - Used for authorization checks
   */
  role: {
    type: String,
    enum: ['ADMIN', 'HOD', 'TEACHER', 'STUDENT'],
    required: true
  },

  /**
   * name (String, Optional)
   * - Display name for the user
   * - For students: Fetched from MySQL student_details table
   * - For teachers/HOD: Set by admin
   * - Null until first login or admin assignment
   */
  name: {
    type: String,
    default: null
  },

  /**
   * mustChangePassword (Boolean)
   * - Forces password change on next login
   * - Set to TRUE for all new accounts
   * - Changed to FALSE after user updates password
   * - Security feature: prevents default passwords
   */
  mustChangePassword: {
    type: Boolean,
    default: true
  },

  // ------------------------------------------------------------
  // ROLE-SPECIFIC FIELDS
  // ------------------------------------------------------------

  /**
   * adminId (String, Optional)
   * - Unique identifier for admin users
   * - Only used when role = 'ADMIN'
   * - Example: ADMIN001
   */
  adminId: {
    type: String,
    default: null
  },

  /**
   * hodId (String, Optional)
   * - Unique identifier for HOD users
   * - Only used when role = 'HOD'
   * - Example: T001
   * - Usually matches teacherId (HOD is also a teacher)
   */
  hodId: {
    type: String,
    default: null
  },

  /**
   * teacherId (String, Optional)
   * - Unique identifier for teacher users
   * - Only used when role = 'TEACHER' or 'HOD'
   * - Example: T010
   * - Used to map teacher to subjects
   */
  teacherId: {
    type: String,
    default: null
  },

  /**
   * usn (String, Optional)
   * - University Seat Number (unique student ID)
   * - Only used when role = 'STUDENT'
   * - Example: 1BI23IS082
   * - Used to fetch student data from MySQL
   */
  usn: {
    type: String,
    default: null,
    uppercase: true       // Always store in uppercase
  },

  /**
   * assignedSubjects (Array of Strings, Optional)
   * - List of subject codes teacher is assigned to
   * - Only used when role = 'TEACHER'
   * - Example: ['21CS51', '21CS52']
   * - Managed by admin through user management panel
   */
  assignedSubjects: {
    type: [String],
    default: []
  },

  // ------------------------------------------------------------
  // METADATA FIELDS
  // ------------------------------------------------------------

  /**
   * createdAt (Date)
   * - Timestamp when user account was created
   * - Auto-generated by MongoDB
   */
  createdAt: {
    type: Date,
    default: Date.now
  },

  /**
   * updatedAt (Date)
   * - Timestamp when user account was last modified
   * - Auto-updated by MongoDB on any change
   */
  updatedAt: {
    type: Date,
    default: Date.now
  }
});

// ============================================================
// SCHEMA MIDDLEWARE
// ============================================================

/**
 * Pre-save hook: Update 'updatedAt' timestamp
 * 
 * Runs before every save() operation
 * Updates the 'updatedAt' field to current time
 */
userSchema.pre('save', function(next) {
  this.updatedAt = Date.now();
  next();
});

// ============================================================
// EXPORT MODEL
// ============================================================

/**
 * User Model
 * 
 * Usage Examples:
 * 
 * 1. Find user by email:
 *    const user = await User.findOne({ email: 'admin@gmail.com' });
 * 
 * 2. Find student by USN:
 *    const student = await User.findOne({ usn: '1BI23IS082', role: 'STUDENT' });
 * 
 * 3. Find all teachers:
 *    const teachers = await User.find({ role: 'TEACHER' });
 * 
 * 4. Update password:
 *    user.password = hashedNewPassword;
 *    user.mustChangePassword = false;
 *    await user.save();
 */
const User = mongoose.model('User', userSchema);

module.exports = User;
